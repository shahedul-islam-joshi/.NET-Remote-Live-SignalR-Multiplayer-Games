@{
    ViewData["Title"] = "NeonGrid";
}

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
    body {
        background-color: #050505;
        color: #e0e0e0;
        font-family: 'Share Tech Mono', monospace;
        overflow-x: hidden;
        margin: 0;
    }

    .neon-text {
        color: #fff;
        text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #00ffcc, 0 0 40px #00ffcc;
        font-family: 'Orbitron', sans-serif;
    }

    .glass-panel {
        background: rgba(20, 20, 20, 0.7);
        border: 1px solid #333;
        box-shadow: 0 0 15px rgba(0, 255, 204, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 4px;
        position: relative;
    }

    .neon-input {
        background: #0a0a0a;
        border: 1px solid #333;
        color: #00ffcc;
        text-align: center;
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
    }

    .btn-neon {
        background: transparent;
        border: 2px solid #00ffcc;
        color: #00ffcc;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 2px;
        transition: all 0.3s ease;
    }

        .btn-neon:hover {
            background: #00ffcc;
            color: #000;
            box-shadow: 0 0 30px #00ffcc;
        }

        /* Disabled state for button */
        .btn-neon:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
        gap: 10px;
        margin: 20px auto;
    }

    .cell {
        background: rgba(255,255,255,0.05);
        border: 1px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3.5rem;
        cursor: pointer;
        height: 100px;
        width: 100px;
        transition: 0.2s;
    }

        .cell.x-move {
            color: #00ffcc;
            text-shadow: 0 0 20px #00ffcc;
        }

        .cell.o-move {
            color: #ff0055;
            text-shadow: 0 0 20px #ff0055;
        }

    .game-item {
        background: rgba(0,0,0,0.5);
        border-left: 3px solid #333;
        color: #aaa;
        cursor: pointer;
        transition: 0.2s;
        margin-bottom: 5px;
    }

        .game-item:hover {
            border-left-color: #00ffcc;
            background: rgba(0, 255, 204, 0.1);
            color: #fff;
            padding-left: 20px;
        }

    .fade {
        opacity: 0;
        transition: opacity 0.5s ease;
    }

        .fade.show {
            opacity: 1;
        }
</style>

<div class="d-flex flex-column min-vh-100 justify-content-center align-items-center">
    <div id="login-section" class="glass-panel p-5 text-center fade show" style="width: 100%; max-width: 500px;">
        <h1 class="neon-text mb-4">NEON GRID</h1>
        <input type="text" id="username" class="form-control neon-input mb-4" placeholder="CODENAME" maxlength="12">
        <button id="btn-init" onclick="login()" class="btn btn-neon w-100 py-3" disabled>CONNECTING...</button>
        <div id="conn-status" class="mt-2 text-muted small">Establish Link...</div>
    </div>

    <div id="lobby-section" class="container d-none fade">
        <div class="row g-4">
            <div class="col-md-8">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex justify-content-between mb-4">
                        <h3 class="neon-text">ACTIVE ZONES</h3>
                        <button onclick="createGame()" class="btn btn-neon px-4">HOST</button>
                    </div>
                    <div id="games-list"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-panel p-4 h-100">
                    <h4 class="text-white">LEADERBOARD</h4>
                    <ul id="leaderboard" class="list-group list-group-flush bg-transparent"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="game-section" class="d-none fade text-center">
        <div class="glass-panel p-5">
            <div class="d-flex justify-content-between mb-4" style="width: 320px;">
                <div id="p1-name" class="text-white fw-bold"></div>
                <div class="text-muted">VS</div>
                <div id="p2-name" class="text-white fw-bold"></div>
            </div>
            <div id="status-bar" class="mb-3 border py-1" style="color:#00ffcc; border-color:#00ffcc">WAITING...</div>
            <div class="grid-container">
                @for (int i = 0; i < 9; i++)
                {
                    <div class="cell" id="cell-@i" onclick="makeMove(@i)"></div>
                }
            </div>
            <button onclick="location.reload()" id="leave-btn" class="btn btn-outline-danger w-100 mt-3 d-none">DISCONNECT</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // [FIX] Configure logging to see errors in browser console (F12)
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/gameHub")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        let myGameId = null;
        let mySymbol = null;
        let isMyTurn = false;

        connection.on("LoginSuccess", (lb) => { switchView('lobby-section'); updateLeaderboard(lb); });

        connection.on("UpdateLobby", (games) => {
            const list = document.getElementById('games-list');
            list.innerHTML = games.length ? '' : '<div class="text-muted">-- NO SIGNALS --</div>';
            games.forEach(g => {
                list.innerHTML += `<div class="game-item p-3 d-flex justify-content-between" onclick="joinGame('${g.gameId}')">
                    <span>${g.hostName}</span><small class="text-success">CONNECT</small></div>`;
            });
        });

        connection.on("GameCreated", (id) => {
            myGameId = id; mySymbol = "X";
            document.getElementById('p1-name').innerText = document.getElementById('username').value;
            document.getElementById('p2-name').innerText = "???";
            switchView('game-section');
        });

        connection.on("GameStarted", (symbol, oppName) => {
            mySymbol = symbol;
            const myName = document.getElementById('username').value;
            document.getElementById(symbol === 'X' ? 'p2-name' : 'p1-name').innerText = oppName;
            document.getElementById(symbol === 'X' ? 'p1-name' : 'p2-name').innerText = myName;
            isMyTurn = (symbol === 'X');
            setStatus(isMyTurn ? "YOUR TURN" : "OPPONENT'S TURN", isMyTurn ? "#00ffcc" : "#ff0055");
        });

        connection.on("MoveMade", (index, result, moverId) => {
            const isMe = moverId === connection.connectionId;
            const symbol = isMe ? mySymbol : (mySymbol === 'X' ? 'O' : 'X');
            const cell = document.getElementById(`cell-${index}`);

            cell.innerText = symbol;
            cell.classList.add(symbol === 'X' ? 'x-move' : 'o-move');

            if (result === "WIN" || result === "DRAW") {
                isMyTurn = false;
                myGameId = null;
                setStatus(result === "WIN" ? (isMe ? "VICTORY" : "DEFEAT") : "DRAW", isMe ? "#00ffcc" : "#ff0055");
                document.getElementById('leave-btn').classList.remove('d-none');
            } else {
                isMyTurn = !isMe;
                setStatus(isMyTurn ? "YOUR TURN" : "OPPONENT'S TURN", isMyTurn ? "#00ffcc" : "#ff0055");
            }
        });

        connection.on("OpponentDisconnected", () => {
            setStatus("SIGNAL LOST", "#ff0055");
            isMyTurn = false;
            document.getElementById('leave-btn').classList.remove('d-none');
        });

        // [FIX] Improved Start Logic with UI feedback
        async function start() {
            const btn = document.getElementById('btn-init');
            const status = document.getElementById('conn-status');

            try {
                await connection.start();
                console.log("SignalR Connected.");
                btn.disabled = false;
                btn.innerText = "INITIALIZE";
                status.innerText = "System Online";
                status.style.color = "#00ffcc";
            } catch (err) {
                console.error(err);
                status.innerText = "Connection Failed. Retrying...";
                status.style.color = "red";
                setTimeout(start, 5000);
            }
        }

        start();

        // [FIX] Async Login with Error Handling
        async function login() {
            const n = document.getElementById('username').value;
            if (!n) { alert("ENTER CODENAME"); return; }

            try {
                await connection.invoke("Login", n);
            } catch (err) {
                console.error(err);
                alert("Login failed: " + err.toString());
            }
        }

        async function createGame() {
            try { await connection.invoke("CreateGame"); } catch(e) { console.error(e); }
        }

        async function joinGame(id) {
            myGameId = id;
            try { await connection.invoke("JoinGame", id); } catch(e) { console.error(e); }
            switchView('game-section');
        }

        async function makeMove(index) {
            if (!isMyTurn || !myGameId) return;
            if (document.getElementById(`cell-${index}`).innerText !== "") return;

            // OPTIMISTIC LOCK
            const oldStatus = document.getElementById('status-bar').innerText;
            isMyTurn = false;
            setStatus("TRANSMITTING...", "#888");

            try {
                await connection.invoke("MakeMove", myGameId, index);
            } catch (err) {
                console.error("Move failed", err);
                isMyTurn = true; // Revert turn if failed
                setStatus(oldStatus, "#00ffcc");
            }
        }

        function switchView(id) {
            ['login-section', 'lobby-section', 'game-section'].forEach(v => {
                const el = document.getElementById(v);
                el.classList.add('d-none'); el.classList.remove('show');
                if(v === id) { el.classList.remove('d-none'); setTimeout(() => el.classList.add('show'), 10); }
            });
        }

        function setStatus(m, c) {
            const s = document.getElementById('status-bar');
            s.innerText = m; s.style.color = c; s.style.borderColor = c;
        }

        function updateLeaderboard(data) {
            const el = document.getElementById('leaderboard');
            el.innerHTML = data.map(s => `<li class="list-group-item bg-transparent text-white d-flex justify-content-between">
                <span>${s.name}</span><b>${s.wins} W</b></li>`).join('');
        }
    </script>
}